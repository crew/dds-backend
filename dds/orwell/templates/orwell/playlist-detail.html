{% extends "orwell/base-index.html" %}
{% block title %}Playlists{% endblock %}
{% block scripts %}

<script type="text/javascript" src="/media/js/slideindex.js"></script>

<script type="text/javascript">

function build_playlist(data) {
  window.data = data; // debug
  $(data).each(function (dummy, datum) {
    var plitem = $('<li>');

    
    if (datum.type === 'PlaylistItemSlide') {
      // PlaylistItemSlide
      plitem.addClass("plis");
      plitem.attr('id', datum.id);
      plitem.text(datum.slide.title);
      plitem.append($('<img>').attr('src', datum.slide.thumbnail));
    } else {
      // PlaylistItemGroup
      plitem.addClass("plig");
      plitem.attr('id', datum.id);
      $(datum.groups).each(function(dummy, group) {
	span = $('<span>').addClass('removable-option')
	                  .attr('id', group.name)
	                  .text(group.name);
	span.append($('<span>').addClass('ro-button')
                               .text('x')
                               .click(function () {$(this).parent().remove()}));
	plitem.append(span);
      })
      cb_id = datum.id + '-weighted';
      plitem.append($('<label>')
		    .attr('for', cb_id)
		    .text('Weighted?'));
      plitem.append($('<input>')
		    .attr('id', cb_id)
		    .attr('type', 'checkbox')
		    .attr('checked', datum.weighted));
    }    
    $("#playlist").append(plitem);
  })	
}

$(function() {

  $.getJSON('{% url orwell-json-playlist-detail plid %}', build_playlist);

});

$(document).ready(function(){
  $("#playlist").sortable();
  $(".plig_toolbox_item").draggable();
  $(".plig").droppable( { accept: ".plig_toolbox_item",
	                  hoverClass: "hover",
	  		  drop: function(id) {
			    alert("Group " + id + " has been dropped.");
			  }} );
  
  $(".plis_toolbox_item").draggable();
  $(".plis").droppable( { accept: ".plis_toolbox_item",
	 		  hoverClass: "hover",
	                  drop: function(id) {
			    alert("Slide " + id.src + " has been dropped");
			  }})
});



(function () {
  /**
   * This scope covers submitting values to the backend
   */
    
  /**
   * submit : -> False
   * handles submitting back the modified playlist
   **/
  function submit() {
    $.post('{% url orwell-playlist-detail plid %}',
	   $("#playlist").each(li_to_json),
	   function(data) { /* TODO: some error checking here! */ return;});
    return false;
  }
  
  /**
   * li_to_json : [HTML LI] -> JSON
   * reads an li element representing a PlaylistItem and returns json 
   * representing it
   **/
  function li_to_json(dummy, li) {
    li = $(li);
    if (li.hasClass("plis")) {
      // PlaylistItemSlide
      return {"type":"plis",
	      "id":li.attr('id')};
    } else {
      // PlaylistItemgroup
      return {"type":"plig",
	      "id":li.attr('id'),
	      "checked":li.find('input').first().attr('checked')};
    }
  }

  // (provide ...)
  window.submit = submit;
})()
</script>

{% endblock %}

{% block content %}

<h1>Playlists</h1>
<form id="slidefilterform">
<select id="selplaylist">
  <option value="">--Playlist--</option>
  {% for pl in playlists %}
  <option value="{{pl.id}}">{{pl}}</option>
  {% endfor %}
</select>

<div class="left">

<ul id="playlist">

</ul>

</div>

<div id="right">

<div id="toolbox">
	{% for slide in slides %}
	<div id="slide{{slide.id}}" class="plis_toolbox_item">
		<img src="{{slide.thumbnail.url}}">
	</div>
	{% endfor %}
	{% for group in groups %}
	<div id="group{{group.id}}" class="plig_toolbox_item">
		{{group}}
	</div>
	{% endfor %}
</div>

</div>

<input type="submit" onclickevent="submit()" />

</form>

{% endblock %}
